## 关系型数据库的事务和ACID

[数据库事务](https://zh.wikipedia.org/wiki/数据库事务)（Transaction）是数据库管理系统执行过程中 执行过程中的一个逻辑单位， 由一个有限的[数据库](https://zh.wikipedia.org/wiki/数据库)操作序列构成。  数据库事务通常包含了一个序列的对数据库的读/写操作。包含有以下两个目的： 

- 为数据库操作序列提供一个从失败中恢复到正常状态的方法，以保证数据库即使在异常状态下仍能保持一致性的方法。
- 当多个应用程序在并发访问数据库时，提供一个隔离方法，以防止彼此的操作互相干扰。

### 数据库事务的基本特性 - ACID

 数据库系统在写入或更新资料的过程中，为保证事务是正确可靠的，所必须具备的[四个特性]( https://zh.wikipedia.org/wiki/ACID )： 

1. 原子性(Atomicity)： 事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行；
2. 一致性(Consistency)： 执行事务前后，数据库从一个一致性状态转换到另一个一致性状态。一致性与原子性是密切相关的。
3. 隔离性(Isolation)： 并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；
4. 持久性(Durability)： 一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响。


### 数据库事务的隔离机制

[事务隔离](https://zh.wikipedia.org/wiki/事務隔離)（Transaction Isolation）定义了数据库系统中一个事务中操作的结果在何时以何种方式对其他并发事务操作可见。

事务隔离限制了数据的访问顺序以满足可序列化和可恢复性。限制数据访问意味着降低了执行的性能，并发控制机制就是要保证在满足这些限制的前提下提供尽可能高的性能。经常在不损害正确性的情况下，为了达到更好的性能，可序列化的要求会减低一些，但是为了避免数据一致性的破坏，可恢复性必须保证。

#### 数据库事务的隔离级别

为了避免上面出现的几种情况，在标准SQL规范中，定义了4个事务隔离级别，不同的隔离级别对事务的处理不同。

- 读未提交（Read Uncommitted）：允许脏读，事务可以看到其他事务尚未提交的修改。
- 读已提交（Read Committed）：对选定对象的写锁一直保持到事务结束，但是读锁在SELECT操作完成后马上释放，因此可能会发生不可重复读。
- 可重复读（Repeatable Read）：需要对选定对象的读锁和写锁一直保持到事务结束，但不要求范围锁，因此可能会发生幻读。
- 可串行化（Serializable）：最高的隔离级别，要求在选定对象上的读锁和写锁保持直到事务结束后才能释放。在SELECT的查询中使用一个WHERE子句来描述一个范围时应该获得一个范围锁，以避免幻读。

隔离级别越高，越能保证数据的完整性和一致性，但是对并发性能的影响也越大。

#### 异常读现象

- 脏读：当一个事务允许读取另外一个事务修改但未提交的数据时，就可能发生脏读；
- 不可重复读：在一次事务中，当一行数据获取两遍得到不同的结果；
- 幻读：在事务执行过程中，当两个完全相同的查询语句执行得到不同的结果集。

#### 隔离级别和异常读现象

| 隔离级别 |   脏读   | 不可重复读 |   幻读   |
| :------: | :------: | :--------: | :------: |
| 读未提交 | 可能发生 |  可能发生  | 可能发生 |
| 读已提交 |    -     |  可能发生  | 可能发生 |
| 可重复读 |    -     |     -      | 可能发生 |
| 可串行化 |    -     |     -      |    -     |

### 参考资料

- [维基百科 - ACID](https://zh.wikipedia.org/wiki/ACID)
- [维基百科 - 事務隔離](https://zh.wikipedia.org/wiki/事務隔離)
- [维基百科 - 数据库事务](https://zh.wikipedia.org/wiki/数据库事务)